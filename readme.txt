FitRose Calorie Tracking Telegram Bot
=====================================

Этот проект реализует телеграм-бота, который помогает пользователям отслеживать дневной калораж и макронутриенты. Бот поддерживает:

* Регистрацию и расчет целевых показателей (BMR, TDEE, калории, белки, жиры, углеводы).
* Ведение дневника питания с поддержкой текста и фотографий.
* Анализ приема пищи через LLM OpenAI (gpt-4o-mini) с возможностью исправления результата.
* Подведение итогов дня с рекомендациями от LLM.
* Просмотр статистики по неделе и месяцу.

Запуск
------

1. Установите зависимости из `requirements.txt`.
2. Установите переменные окружения `TELEGRAM_TOKEN`, `OPENAI_API_KEY`, при необходимости `CALORIE_BOT_DB`.
   Например, в Linux/MacOS вы можете выполнить:

   ```bash
   export TELEGRAM_TOKEN="ваш_токен_бота"
   export OPENAI_API_KEY="ваш_api_ключ"
   # необязательно, путь к базе
   export CALORIE_BOT_DB="/полный/путь/к/calorie_bot.db"
   ```

   В Windows (PowerShell) используйте:

   ```powershell
   setx TELEGRAM_TOKEN "ваш_токен_бота"
   setx OPENAI_API_KEY "ваш_api_ключ"
   setx CALORIE_BOT_DB "C:\\path\\to\\calorie_bot.db"  # необязательно
   ```

   После установки переменных перезапустите терминал, чтобы новые значения применились.
3. Запустите бота: `python -m calorie_bot.bot`.

Логирование
-----------

Бот выводит структурированные сообщения в формате `key=value`. Отдельный логгер
`calorie_bot.commands` фиксирует ключевые события команд вместе с `user_id` и
названием команды. По умолчанию все логи отправляются в `stdout`, поэтому их
легко читать в терминале или собирать через Docker/Kubernetes.

Чтобы дополнительно писать события в файл, задайте переменную окружения
`CALORIE_BOT_LOG_FILE` перед запуском:

```bash
export CALORIE_BOT_LOG_FILE="/var/log/calorie_bot.log"
python -m calorie_bot.bot
```

Файл будет содержать как общие сообщения, так и специализированные события
`calorie_bot.commands`. Этот файл удобно подключать к агентам Promtail или
Filebeat: направьте его в Loki или Logstash/Beats, чтобы отправлять данные в
Loki/ELK. В контейнерах можно также прокинуть `stdout` в Promtail/Fluent Bit —
формат остаётся тем же `key=value`, и поля `user_id`/`command` легко выделяются
правилами парсинга.

Основные команды бота
---------------------

* `/start` – регистрация пользователя и вывод целевых показателей.
* `/log_day` – добавить прием пищи за выбранный день.
* `/finish_day` – завершить день и получить рекомендации.
* `/stats` – статистика по неделе или месяцу.
* `/profile` – просмотр личных целей.
* `/admin_stats` – административные метрики (доступно указанным администраторам).
* `/cancel` – отменить текущий ввод приема пищи.

Требования
---------

* Python 3.11+
* Библиотеки: `python-telegram-bot`, `openai`

Структура
---------

* `calorie_bot/calculations.py` – формулы расчета калорий и макросов.
* `calorie_bot/storage.py` – работа с базой данных SQLite.
* `calorie_bot/llm.py` – интеграция с OpenAI.
* `calorie_bot/bot.py` – обработчики телеграм-бота.
* `calorie_bot/config.py` – загрузка конфигурации.

Административная статистика
---------------------------

Для доступа к административным метрикам задайте переменную окружения `CALORIE_BOT_ADMINS` со списком Telegram ID через запятую. Команда `/admin_stats` выводит:

* DAU и WAU по событиям.
* Среднее число приёмов пищи на активного пользователя за день и за неделю.
* Распределение приёмов по типам (завтрак/обед и т.д.) и долю добавлений через фото.
* Количество и долю корректировок анализа.
* Число завершённых дней и ошибок LLM за последнюю неделю.
